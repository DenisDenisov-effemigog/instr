<template>
    <div class="contacts__wrap">
        <form v-if="!answerFlag" action="" class="contacts-form" @submit.prevent="submit" ref="form">
            <h3 class="contacts-form__title">{{  $tc('contacts.form_title') }}</h3>
            <div class="contacts-form__column">
                <label name="name" class="contacts-form__label">
                    <input
                        class="contacts-form__input"
                        :class="{'contacts-form__input--error': $v.name.$error}"
                        type="text"
                        name="name"
                        id="name"
                        autocomplete="organization"
                        autocorrect="off"
                        v-model.trim="$v.name.$model">
                    <span class="contacts-form__label-text"
                        :class="{'contacts-form__label-text--up': $v.name.required}"
                    >{{ $tc('contacts.form_name') }}</span>
                    <svg viewBox="0 0 24 24"
                        class="contacts-form__label-icon" 
                        v-if="$v.name.required"
                        @click="$v.name.$model = ''">
                        <use :xlink:href="templatePath + 'images/sprite.svg#icons__times-small'"></use>
                    </svg>
                    <div class="contacts-form__error-text contacts-form__error-text--invalid"
                        v-if="$v.name.$error">{{ $tc('text.error') }}</div>
                </label>
                <label name="phone" class="contacts-form__label">
                    <the-mask
                        class="contacts-form__input"
                        :class="{'contacts-form__input--error': $v.phone.$error}"
                        type="tel"
                        :mask="phoneMask"
                        :tokens="tokens"
                        :masked="true"
                        name="phone"
                        id="phone"
                        autocomplete="tel"
                        autocorrect="off"
                        v-model.trim="phone"/>
                    <span class="contacts-form__label-text"
                        :class="{'contacts-form__label-text--up': $v.phone.required}"
                    >{{ $tc('title.phone_number') }}</span>
                    <svg viewBox="0 0 24 24"
                        class="contacts-form__label-icon"
                        v-if="$v.phone.required"
                        @click="$v.phone.$model = ''">
                        <use :xlink:href="templatePath + 'images/sprite.svg#icons__times-small'"></use>
                    </svg>
                    <div class="contacts-form__error-text contacts-form__error-text--invalid"
                        v-if="$v.phone.$error">{{ $tc('text.error') }}</div>
                </label>
                <label name="email" class="contacts-form__label">
                    <input
                        class="contacts-form__input"
                        :class="{'contacts-form__input--error': $v.newEmail.$error}"
                        type="text"
                        name="email"
                        id="email"
                        autocomplete="email"
                        autocorrect="off"
                        autocapitalize="off"
                        v-model.trim="newEmail">
                    <span class="contacts-form__label-text"
                        :class="{'contacts-form__label-text--up': $v.newEmail.required}"
                    >{{ $tc('title.email') }}</span>
                    <svg viewBox="0 0 24 24"
                        class="contacts-form__label-icon"
                        v-if="$v.newEmail.required"
                        @click="$v.newEmail.$model = ''">
                        <use :xlink:href="templatePath + 'images/sprite.svg#icons__times-small'"></use>
                    </svg>
                    <div class="contacts-form__error-text contacts__error-text--invalid"
                        v-if="$v.newEmail.$error && !emailReg">{{ $tc('text.error') }}</div>
                    <div class="contacts-form__error-text contacts__error-text--invalid"
                        v-if="emailReg">{{ $tc('text.error_reg') }}</div>
                </label>
                <label name="city" class="contacts-form__label">
                    <input
                        class="contacts-form__input"
                        type="text"
                        name="city"
                        id="city"
                        autocomplete="city"
                        autocorrect="off"
                        v-model.trim="$v.city.$model">
                    <span class="contacts-form__label-text"
                        :class="{'contacts-form__label-text--up': $v.city.required}"
                    >{{ $tc('contacts.form_town') }}</span>
                    <svg viewBox="0 0 24 24"
                        class="contacts-form__label-icon" 
                        v-if="$v.city.required"
                        @click="$v.city.$model = ''">
                        <use :xlink:href="templatePath + 'images/sprite.svg#icons__times-small'"></use>
                    </svg>
                </label>
            </div>
            <label for="message" class="contacts-form__label contacts-form__label--column">
                <textarea
                    class="contacts-form__textarea"
                    :class="{'contacts-form__textarea--error': $v.message.$error}"
                    name="message"
                    id="message"
                    v-model.trim="message"
                ></textarea>
                <span class="contacts-form__label-text"
                    :class="{'contacts-form__label-text--up': $v.message.required}"
                >{{ $tc('text.message') }}</span>
                <span class="contacts-form__error-text" v-if="$v.$error">*{{ $tc('text.required') }}</span>
            </label>
            <div class="contacts-form__stick">
                <label for="files" class="contacts-form__stick-label">
                    <input id="files" name="files" type="file" ref="file" class="contacts-form__stick-input">
                    {{ $tc('contacts.form_stick_input') }}
                </label>
                <span class="contacts-form__stick-text">
                    {{ $tc('contacts.form_stick_text') }}
                </span>
            </div>
            <input type="submit" class="contacts-form__btn" :value="$tc('contacts.form_btn')">
        </form>
        <div v-else class="contacts-form__answer">
            <div class="contacts-form__answer-text">
                Ваше сообщение отправлено!
            </div>
        </div>
    </div>
</template>

<script>

    import {required, email} from "vuelidate/lib/validators"
    import {TheMask} from 'vue-the-mask'

    import config from "../../config";

    import * as Api from '../../api/index'

    let api = Api.getInstance();
    let base64 = require('base-64');

export default {
    name:"contacts-form",
    components: {
        TheMask
    },
    props: {
        phoneMask:{
            type: String,
            required: true,
        },  
    },
    validations: {
            name: {
                required
            },
            city: {
                required
            },
            phone: {
                required
            },
            newEmail: {
                required,
                email
            },
            message: {
                required,
            }
        },
        data() {
            return {
                name: '',
                phone: '',
                newEmail: '',
                city:'',
                message:'',
                tokens: config.phoneTokens,
                answerFlag: false,
                emailReg: false
            }
        },
        methods:{
            async submit(){
                this.$v.$touch();
                let attachment = {};
                let mailReg = /^([A-Za-z0-9_\-\.])+\@([A-Za-z0-9_\-\.])+\.([A-Za-z]{2,4})$/;
                if(!mailReg.test(this.newEmail) && !this.newEmail == ''){
                    this.emailReg = true
                }else{
                    this.emailReg = false
                }
                if (!this.$v.name.$invalid &&
                    !this.$v.newEmail.$invalid && 
                    !this.$v.phone.$invalid &&
                    !this.$v.message.$invalid &&
                    !this.emailReg
                ) {
                    if(this.$refs.file.files[0]){
                        attachment.name = this.$refs.file.files[0].name
                        let data = await this.getBase64(this.$refs.file.files[0])
                        attachment.data = data
                    }
                    this.sendData(this.name, this.phone, this.newEmail, this.message, this.city, attachment);
                }else{
                    console.log("zapolni");
                }
                
            },
            sendData(name, phone, email, message, city, attachment){
                api.sendContactForm(name, phone, email, message, city, attachment).then(answer => {
                    if(answer){
                        this.answerFlag = true
                    }
                })
            },
            getBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                });
            }
        }
}
</script>