<template>
    <div class="add-to-cart" :class="{'add-to-cart--big': size==='big'}">
        <div class="add-to-cart__in-cart" v-if="amount > 0 && !disabled">
			<div
				class="add-to-cart__button add-to-cart__button_decrease"
				:disabled="decreaseDisabled"
				@click="decrease"
			>
                <svg>
                    <use :xlink:href="templatePath + 'images/sprite.svg#minus'"></use>
                </svg>
			</div>
            
            <input 
                v-if="allowNull === false" 
                type="number" 
                class="add-to-cart__amount-input" 
                @change="changeVal($event.target.value)" 
                :value="amount"
            > 
            <span v-else class="add-to-cart__amount">
                <span v-if="text">{{ text }}</span>
                <template>{{ amount }} шт.</template>
            </span>
            
			<div
				class="add-to-cart__button add-to-cart__button_increase"
				:disabled="increaseDisabled"
				@click="increase"
			>
                <svg viewBox="2 2 12 12">
                    <use :xlink:href="templatePath + 'images/sprite.svg#plus'"></use>
                </svg>
			</div>
        </div>
		<div v-else>
            <div 
                class="add-to-cart__add" 
                :class="{'add-to-cart__add--smaller': changeIcon && width < 760}"
                :disabled="disabled"
                @click="increase"
            >
                <svg v-if="changeIcon && width < 760 && !disabled">
                    <use :xlink:href="templatePath + 'images/sprite.svg#icons__cart'"></use>
                </svg>
                <svg viewBox="-2 -1 12 12" v-else-if="amount > 0 && disabled">
                    <use :xlink:href="templatePath + 'images/sprite.svg#check'"></use>
                </svg>
              <template v-else>{{ buttonTitle }}</template>  
            </div>
		</div>
    </div>
</template>

<script>
    import config from "../../config";

    export default {
        name: "add-to-cart",
        props: {
            productId: {
                type: Number,
                required: true
            },
            maxAmount: {
                type: Number,
                required: false,
                default: 100
            },
            allowNull:{
                type:Boolean,
                required: false,
                default: true
            },
            changeIcon: {
                type: Boolean,
                default: false,
            },
            text: {
                type: String,
                default: '',
                required: false,
            },
            buttonTitle: {
                type: String,
                default: 'В корзину',
                required: false,
            },
            size: {
                type: String,
                default: '',
                required: false,
            },
            productOrderPosition: {
                type: Number,
                default: 0,
                required: false,
            },
        },
        data() {
            return {
                loading: false,
                disabled: false,
                amount: 0,
                width: 0,
                _debounce_timer: null,
                _loading_timer: null,
            };
        },
        computed: {
            storeAmount() {
                return this.$store.getters.basketProductQuantity(this.productId);
            },
            increaseDisabled() {
                return this.amount >= this.maxAmount;
            },
            decreaseDisabled() {
                return this.amount <= this.allowedDecreaseAmount;
            },
            allowedDecreaseAmount() {
                return this.allowNull ? 0 : 1;
            },
        },
        watch: {
            storeAmount(newValue) {
                if(!this._debounce_timer) {
                    this.amount = newValue;
                }
            }
        },
        mounted() {
            this.amount = this.storeAmount;
        },
        created() {
            window.addEventListener('resize', this.updateWidth);
            this.updateWidth()
            window.addEventListener('scroll', this.mobileScroll);
        },
        methods: {
            setAmount(amount) {
                let vm = this;

                // Включение лоадера при долгой загрузке
                if (vm._loading_timer) {
                    clearTimeout(vm._loading_timer);
                    vm._loading_timer = null;
                }
                vm._loading_timer = setTimeout(function () {
                    vm.loading = true;
                }, config.loading_timeout);


                vm.$store.dispatch('basketSendQuantity', {
                    productId: this.productId,
                    quantity: amount
                }).finally(() => {
                    vm.loading = false;

                    if (vm._loading_timer) {
                        clearTimeout(vm._loading_timer);
                        vm._loading_timer = null;
                    }
                });
            },
            startSetAmount() {
                let vm = this;
                if (vm._debounce_timer) {
                    clearTimeout(vm._debounce_timer);
                    vm._debounce_timer = null;
                }
                this._debounce_timer = setTimeout(function () {
                    vm.setAmount(vm.amount);
                }, config.debounce_timeout);
            },
            decrease() {
                if (this.amount > this.allowedDecreaseAmount) {
                    this.amount--;
                    this.startSetAmount();
                }
            },
            updateWidth() {
                this.width = window.innerWidth;
            },
            increase() {
                if (this.amount < this.maxAmount) {
                    this.amount++;
                    if(this.changeIcon) {
                        this.disabled = true
                    }
                    this.startSetAmount();
                }
            },
            changeVal(e){
                this.amount = Number(e)
                if (this.amount <= this.maxAmount && this.amount >= this.allowedDecreaseAmount){
                    return
                }else{
                    if (this.amount >= this.maxAmount){
                        this.amount = this.maxAmount
                        return
                    }
                    if (this.amount <= this.allowedDecreaseAmount){
                        this.amount = this.allowedDecreaseAmount
                        return
                    }
                }
            },
            mobileScroll(){
                if(window.innerWidth < 768) {
                    let windowPosition = window.pageYOffset
                    let orderPosition = this.productOrderPosition - 24
                    if(windowPosition > orderPosition){
                        this.$eventBus.$emit('openStickyButton', 'Добавить в корзину')
                    } else{
                        this.$eventBus.$emit('closeStickyButton')
                    }
                }
            },
        }
    }
</script>